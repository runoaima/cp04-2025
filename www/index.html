<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>
  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">
  <style>

  </style>
  <script>
    // timer処理
    $(function(){
        setInterval(function(){
            timer();
        },500);
    });  
      
    // ready クリックの処理の登録
    $(function() { 
        $('#date').click(function(e) {
            setDebugMode(e);
        });
      
        $('#btnA').click(function(e) {
            btnAClick(e);
        });

        $('#btnB').click(function(e) {
            btnBClick(e);
        });

        $('#btnC').click(function(e) {
            btnCClick(e);
        });

        $('#sounds').change(getSound);
        init();
    });
    
    function rgbToColor(r,g,b){
        return "#" + hex02(r)+hex02(g)+hex02(b);
    }
    
    function hex02(x) {
        var str = "0"+x.toString(16);
        return str.substring(str.length-2);
    }
    
    function decS2(x) {
        if (x<10) {
            return "&nbsp;"+x.toString(10);
        } else { 
            return x.toString(10);
        }
    }
    
    function dec02(x) {
        var str = "0"+x.toString(10);
        return str.substring(str.length-2);        
    }

    var debug = false;
    // Statusがクリックされた時の処理
    function setDebugMode(e){
        debug = !debug;
        $("#status").html("Debug Mode: "+debug);
    }
    
    // 座標を計算
    // getX(中心x座標,角度(1で一周),長さ(1で最大)
    function getX(cx,d,r){
        return cx + Math.sin(d*2*3.14)*cx*r;
    }
    // getY(中心y座標,角度(1で一周),長さ(1で最大)
    function getY(cy,d,r){
        return cy - Math.cos(d*2*3.14)*cy*r;
    }
    // 線を描く
    // line(context,x1,y1,x2,y2,線の太さ,色)    
    function line(ctx,x1,y1,x2,y2,width,color){
        ctx.lineWidth = width; 
        ctx.lineCap = "round"; 
        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();        
    }    
    // 時計 clock(時, 分, 秒, 残り時間が短い時に不要な針を隠す)
    function clock(hour,minute,second,hide){
        var canvas = $('#mycanvas')[0];
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(0,0,0, 0.4)'; 
        ctx.fillRect(0,0,canvas.width,canvas.height);
        var cx = canvas.width/2;
        var cy = canvas.height/2;
        var ds = second/60;
        var dm = (minute+ds)/60;
        var dh = (hour%12+dm)/12;

        for(var i = 0; i < 60; i++) {
            var px = getX(cx,i/60,0.9);
            var py = getY(cy,i/60,0.9);
            ctx.fillStyle = 'rgb(255, 159, 70)'; 
            ctx.beginPath();
            ctx.arc(px, py, 2, 0, Math.PI*2, false);
            ctx.fill();
        }
        
        for(var i = 0; i < 12; i++) {
            var px = getX(cx,i/12,0.9);
            var py = getY(cy,i/12,0.9);
            ctx.fillStyle = 'rgb(255, 159, 70)'; 
            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI*2, false);
            ctx.fill();
        }

        if ((!hide) || hour > 0) {
            var px = getX(cx,dh,0.4);
            var py = getY(cy,dh,0.4);
            line(ctx,cx,cy,px,py,20, 'rgb(255, 100, 162)')
        }
        if ((!hide) || hour > 0|| minute > 0) {
            var px = getX(cx,dm,0.6);
            var py = getY(cy,dm,0.6);
            line(ctx,cx,cy,px,py,15, 'rgb(128, 255, 162)')
        }
        var px = getX(cx,ds,0.9);
        var py = getY(cy,ds,0.9);
        line(ctx,cx,cy,px,py,5, 'rgb(128, 100, 255)')
    }

    // 残り秒数アナログ表示
    function analog(rest){
        var h = parseInt(rest/3600);
        var m = parseInt((rest-h*3600)/60);
        var s = parseInt(rest-h*3600-m*60);
        clock(h,m,s,true);

    }



// これより上は編集しなくて良い


    // 変数宣言
    var active = false;
    var pause = false;
    var startTime = 0;
    var period = 0;
    var rest = 0;
    var etime = 0;
    var sound = "pin1";
    
    // ボタンの初期設定
    function init(){
        $('#btnA').prop('disabled', false).text("開始");
        $('#btnC').prop('disabled', true);
        btnCClick(null);
    }

    // Alarmの処理
    function alarm(){
        var canvas = $("#mycanvas")[0];
        var ctx = canvas.getContext("2d");
        var img = new Image();
        img.src = "ksuisbg.gif";
        img.onload = function() {
            ctx.drawImage(img, 0, 0, 300, 300);
        };
        var audio = new Audio();
        if (sound == "pin1") {
            audio.src = "pin.wav";
        } else if (sound == "pin2") {
            audio.src = "pin2.mp3";
        } else if (sound == "pin3") {
            audio.src = "pin3.mp3";
        } else if (sound == "pin4") {
            audio.src = "pin4.mp3";
        } else if (sound == "pin5") {
            audio.src = "pin5.mp3";
        } else if (sound == "pin6") {
            audio.src = "pin6.mp3";
        } else if (sound == "pin7") {
            audio.src = "pin7.mp3";
        }
        audio.play();        
    }
    
    // ButtonAがクリックされた時の処理
    function btnAClick(e){
        getSound();
        if (!active && !pause) {
            active = true;
            pause = false;
            startTime = new Date();
            $('#btnA').text("停止");
            $('#btnC').prop('disabled', false);
        } else if (active) {
            active = false;
            pause = true;
            $('#btnA').text('再開');
        } else if (!active && pause) {
            active = true;
            pause = false;
            startTime = new Date(new Date() - etime * 1000); 
            $('#btnA').text('停止');
        }
        
    }

    // ButtonBがクリックされた時の処理

    // ButtonCがクリックされた時の処理
    function btnCClick(e){
        $('#btnA').prop('disabled', false).text("開始");
        $('#btnC').prop('disabled', true);
        alarm();
        updateTime();
        active = false;
        pause = false;
    }
    
 
    // 繰り返し実行する処理
    function timer(){  
        if (active) {
            etime = parseInt( (new Date() - startTime)/1000 );
            rest = period - etime;
            var m = parseInt(rest/60);
            var s = parseInt(rest - m*60);
            $("#time").html("経過時間： " + etime + "秒");
            $("#remain").html("残り時間： " + m + "分" + s + "秒");
            analog(rest);
            var rh = parseInt(etime/3600);
            var rm = parseInt(etime/60);
            var rs = parseInt(etime - rm*60);
            if (rest <= 0) {
                active = false;
                alarm();
                $('#btnA').text('開始');
                const label = document.getElementById("labelInput").value;
                let message;
                if (label.trim() !== "") {
                    message = label;
                } else {
                    message = "タイマー";
                }
                alert(rh + "時間" + rm + "分" + rs + "秒" + message);
            }
        }
    }

    function getSound() {
        sound = document.getElementById("sounds").value;     
    }

    // 時間の更新
    $(function() {
        $("#hour, #minute, #second").on("input", function() {
            updateTime();
        });
    });

    function updateTime() {
        const h = parseInt($("#hour").val()) || 0;
        const m = parseInt($("#minute").val()) || 0;
        const s = parseInt($("#second").val()) || 0;
        period = h * 3600 + m * 60 + s;
        rest = period;
        if(h > 0){
            $("#remain").html("残り時間： " + h + "時間" + m + "分" + s + "秒");
        }else{
            $("#remain").html("残り時間： " + m + "分" + s + "秒");
        }
        $("#time").html("経過時間： 0秒");
        var hstr = "時間: ";
        var hstr1 = "";
            if(h/10 >= 1){
                for(let i = 0; i < Math.floor(h / 10); i++){
                hstr += "◎";
            }
        }
        for(let i = 0; i < h%10; i++){
            hstr1 += "〇";
        }
        $("#hourStr").html(hstr + hstr1);
        if(h <= 0){
            $("#hourStr").html("");
        }
        var mstr = "分: ";
        var mstr1 = "";
            if(m/10 >= 1){
                for(let i = 0; i < Math.floor(m / 10); i++){
                mstr += "◎";
            }
        }
        for(let i = 0; i < m%10; i++){
            mstr1 += "〇";
        }
        $("#minuteStr").html(mstr + mstr1);
        var sstr = "秒: ";
        var sstr1 = "";
            if(s/10 >= 1){
                for(let i = 0; i < Math.floor(s / 10); i++){
                sstr += "◎";
            }
        }
        for(let i = 0; i < s%10; i++){
            sstr1 += "〇";
        }
        $("#secondStr").html(sstr + sstr1);
    }

  </script>
</head>
<body>
    <h2 style="font-size:28px; margin-bottom:20px; color: #ffff">タイマー</h2>

    <canvas id="mycanvas" width="200" height="200">Test</canvas>

    <div id="hourStr">〇</div>
    <div id="minuteStr">〇</div>
    <div id="secondStr">〇</div>

    <div id="remain">Remaining time</div>
    <div id="time">Time</div>
    <button id="btnA">開始</button>   
    <button id="btnC">キャンセル</button>  
    <input type="number" id="hour" value=0 >
    <a style="position:absolute; top:520px; left:29%; width:80px; height:40px; color: #ffff">時間</a>
    <input type="number" id="minute" value=3 >
    <a style="position:absolute; top:520px; left:62%; width:80px; height:40px; color: #ffff">分</a>
    <input type="number" id="second" value=0 >
    <a style="position:absolute; top:520px; left:92%; width:80px; height:40px; color: #ffff">秒</a>

    <a style="position:absolute; top:600px; left:10%; width:80px; height:40px; color: #ffff">ラベル</a>
    <input type="label" id="labelInput" placeholder="タイマー">
    <a style="position:absolute; top:640px; left:10%; width:120px; height:40px; color: #ffff">タイマー終了時</a>
    <select id="sounds" name="sounds">
        <option value="pin1">pin1</option>
        <option value="pin2">pin2</option>
        <option value="pin3">pin3</option>
        <option value="pin4">pin4</option>
        <option value="pin5">pin5</option>
        <option value="pin6">pin6</option>
        <option value="pin7">pin7</option>
    </select>

</body>
</html>
